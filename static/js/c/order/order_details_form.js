// Generated by CoffeeScript 1.5.0
(function() {
  var OrderDetailsForm;

  window.OrderDetailsForm = OrderDetailsForm = (function() {

    function OrderDetailsForm(config) {
      this.containerClass = ".order-form-container";
      this.onDelete = this.defaultOnDelete;
      this.onEdit;
      this.data = {
        order: [],
        products: {}
      };
      this.refreshOrderForm();
    }

    OrderDetailsForm.prototype.addProduct = function(product) {
      if (!product) {
        return;
      }
      if (this.data.products[product.id]) {
        alert("已经添加了这件商品，不能重复添加！如需添加或修改，请点击下面对应商品的编辑按钮！谢谢合作！");
        return false;
      }
      this.data.order.push(product.id);
      this.data.products[product.id] = product;
      return true;
    };

    OrderDetailsForm.prototype.editProduct = function(product) {
      if (!product) {
        return;
      }
      this.data.products[product.id] = product;
      return true;
    };

    OrderDetailsForm.prototype.setData = function(json) {
      console.log(typeof json);
      this.data = json;
      console.log(typeof this.data);
      return this.refreshOrderForm();
    };

    OrderDetailsForm.prototype.refreshOrderForm = function() {
      var id, product, q, sumPrice, sumQuantity, tbody, totalPrice, totalQuantity, tr, _i, _j, _len, _len1, _ref, _ref1;
      tbody = $("" + this.containerClass + " tbody");
      tbody.html("");
      sumQuantity = 0;
      sumPrice = 0;
      _ref = this.data.order;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        id = _ref[_i];
        product = this.data.products[id];
        if (product) {
          totalQuantity = 0;
          _ref1 = product.quantity;
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            q = _ref1[_j];
            totalQuantity += q[2];
          }
          totalPrice = totalQuantity * product.price;
          sumQuantity += totalQuantity;
          sumPrice += totalPrice;
          tr = $(this.generateTR(product, totalQuantity, totalPrice).join("\n"));
          tbody.append(tr);
          this.bindAction(tr, id);
        } else {
          if (console) {
            console.log("[OrderDetailsForm] Error id in order list " + id + ".");
          }
        }
      }
      return this.updateSummary(sumQuantity, sumPrice);
    };

    OrderDetailsForm.prototype.bindAction = function(tr, id) {
      tr.find(".odf-edit").on("click", $.proxy(this.onODFEdit(id), this));
      return tr.find(".odf-delete").on("click", $.proxy(this.onODFDelete(id), this));
    };

    OrderDetailsForm.prototype.onODFEdit = function(id) {
      return function(e) {
        e.preventDefault();
        if (this.onEdit) {
          return this.onEdit(this.data.products[id]);
        }
      };
    };

    OrderDetailsForm.prototype.onODFDelete = function(id) {
      return function(e) {
        e.preventDefault();
        if (this.onDelete) {
          return this.onDelete(this.data.products[id]);
        }
      };
    };

    OrderDetailsForm.prototype.defaultOnDelete = function(product) {
      var idx;
      if (!confirm("真的要删除这条记录么？")) {
        return;
      }
      delete this.data.products[product.id];
      idx = this.data.order.indexOf(product.id);
      if (idx >= 0) {
        console.log(this.data.order.splice(idx, 1));
      }
      return this.refreshOrderForm();
    };

    OrderDetailsForm.prototype.updateSummary = function(sumQuantity, sumPrice) {
      var tfoot;
      tfoot = $("" + this.containerClass + " tfoot");
      tfoot.find(".sumQuantity").html(sumQuantity);
      return tfoot.find(".sumPrice").html(sumPrice);
    };

    OrderDetailsForm.prototype.generateTR = function(json, totalQuantity, totalPrice) {
      var htmls, nquantity, q, quantities, quantity, _i, _j, _len, _len1, _ref, _ref1;
      quantities = [];
      _ref = json.quantity;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        q = _ref[_i];
        if (q[2] > 0) {
          quantities.push(q);
        }
      }
      nquantity = quantities.length;
      htmls = [];
      htmls.push("<tr>");
      htmls.push("  <td valign='top' rowspan='" + nquantity + "'>");
      htmls.push("    <strong>" + json.name + "</strong>");
      htmls.push("    <input type='hidden' name='Order.Details.ProductId' value='" + json.id + "' />");
      htmls.push("    <input type='hidden' name='Order.Details.SellingPrice' value='" + json.price + "' />");
      htmls.push("    <input type='hidden' name='Order.Details.Color' value='" + quantities[0][0] + "' />");
      htmls.push("    <input type='hidden' name='Order.Details.Size' value='" + quantities[0][1] + "' />");
      htmls.push("    <input type='hidden' name='Order.Details.Quantity' value='" + quantities[0][2] + "' />");
      htmls.push("    <input type='hidden' name='Order.Details.Note' value='" + json.note + "' />");
      htmls.push("  </td>");
      htmls.push("  <td valign='top' rowspan='" + nquantity + "'>");
      htmls.push("    <span class='price'>" + json.price + "</span>");
      htmls.push("  </td>");
      htmls.push("  <td>" + quantities[0][0] + "</td>");
      htmls.push("  <td>" + quantities[0][1] + "</td>");
      htmls.push("  <td>" + quantities[0][2] + "</td>");
      htmls.push("  <td valign='top' align='center' rowspan='" + nquantity + "'>");
      htmls.push("      <strong>" + totalQuantity + "</strong></td>");
      htmls.push("  <td valign='top' align='right' rowspan='" + nquantity + "'>");
      htmls.push("      <strong class='price'>" + totalPrice + "</strong></td>");
      htmls.push("  <td valign='top' rowspan='" + nquantity + "'>" + json.note + "</td>");
      htmls.push("  <td valign='top' rowspan='" + nquantity + "'>");
      htmls.push("      <a href='#' class='odf-edit'>编辑</a><span class='vline'>|</span>");
      htmls.push("      <a href='#' class='odf-delete'>删除</a>");
      htmls.push("  </td>");
      htmls.push("</tr>");
      _ref1 = quantities.slice(1, nquantity);
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        quantity = _ref1[_j];
        htmls.push("<tr>");
        htmls.push("  <td>" + quantity[0] + "</td>");
        htmls.push("  <td>" + quantity[1] + "</td>");
        htmls.push("  <td>" + quantity[2] + "</td>");
        htmls.push("    <input type='hidden' name='Order.Details.ProductId' value='" + json.id + "' />");
        htmls.push("    <input type='hidden' name='Order.Details.SellingPrice' value='" + json.price + "' />");
        htmls.push("    <input type='hidden' name='Order.Details.Color' value='" + quantity[0] + "' />");
        htmls.push("    <input type='hidden' name='Order.Details.Size' value='" + quantity[1] + "' />");
        htmls.push("    <input type='hidden' name='Order.Details.Quantity' value='" + quantity[2] + "' />");
        htmls.push("    <input type='hidden' name='Order.Details.Note' value='" + json.note + "' />");
        htmls.push("</tr>");
      }
      return htmls;
    };

    OrderDetailsForm.prototype.addTestData = function() {
      var testproduct;
      testproduct = {
        id: 1,
        name: "绣虎头",
        price: 138,
        productPrice: 120,
        note: "no note",
        colors: ["红色", "蓝色"],
        sizes: ["S", "M"],
        quantity: [["红色", "S", 101], ["红色", "M", 102], ["蓝色", "S", 203], ["蓝色", "M", 204]]
      };
      this.addProduct(testproduct);
      return this.addProduct({
        id: 2,
        name: "鲸鱼宝宝",
        price: 138,
        note: "no note",
        quantity: [["默认颜色", "均码", 1098]]
      });
    };

    return OrderDetailsForm;

  })();

  $(function() {
    return new OrderDetailsForm;
  });

}).call(this);
