###
 SYD Project
 Suggest Control

###
class SuggestControl
  constructor: (param)->
    this.param = param
    # console.log 'SuggestControl initialized.'
    this.id_input = $ "#"+param.id+"_id"
    this.query_input = $ "#"+param.id+"_query"

  init: (params)->
    console.log 'init suggest'
    console.log params
    if not params
      console.log "override options"
      _ = this
      params = {
        serviceUrl: "/ajax/suggest/" + _.param.category
        # lookup: this.countries,
        onSelect: (suggestion)->
          _.id_input.val(suggestion.data)
          _.query_input.val(_.formatValue(suggestion.value))
        onSearchStart: (query)->
          _.id_input.val('')
        formatResult:(suggestion, currentValue) ->
          # TODO highlight matches...

          # console.log suggestion
          # console.log currentValue
          #reEscape = new RegExp('(\\' + ['/', '.', '*', '+', '?', '|', '(', ')', '[', ']', '{', '}', '\\'].join('|\\') + ')', 'g'),
          #pattern = '(' + currentValue.replace(reEscape, '\\$1') + ')';
          #return ">>> " + suggestion.value.replace(new RegExp(pattern, 'gi'), '<strong>$1<\/strong>')
          return _.formatValue(suggestion.value)
      }

    c = this.query_input.autocomplete(params)

  # format the composed value
  formatValue:(value)->
    return value.substr(value.indexOf("||") + 2)

## expose
window.SuggestControl = SuggestControl
